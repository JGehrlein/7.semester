---
title: "Survival"
author: "Jonas Gehrlein"
date: "24 okt 2018"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(survival) 
library(here)
library(survminer)
```
code for fitting Kaplan-Meier and log-rank test and for displaying 
survival curves for each type of media

```{r}
data <- read.table(here('data','Worm_9days.csv'), header = TRUE, sep = ";", dec = ",")
head(data)
```

here() should show that your position is in the folder 7.semester else select the active project to be 7.semester in the upper right corner. 

Or make a new .Rproj file in the folder 7.semester. There is a problem with the numbers of the worms so we change that with col.names()
```{r}
colnames(data)<-c("Time","status","media",'Replicate')
head(data)
```

Then we create a survival object with the survival package and make a kaplan-meier curve
```{r}
data$Survobj <- with(data,Surv(data$Time, event = data$status))
km <- survfit(Survobj ~ media, data = data,conf.type = "log-log", error = "greenwood")
plot(km, col = c("grey5","black"))
points(km, pch = '*', cex = 2)
legend("bottomleft",legend = c("FG20","OP50" ), col = c("blue","red"), lwd=1)
```

Shows errorbars and lineplot based on one of Anders papers https://onlinelibrary.wiley.com/doi/full/10.1111/acel.12165
This is done by extracting the surviving proportion, standard errors from survfit().  and then plotting with base r
```{r}
df_fly <- data.frame(km$time[1:5],km$surv[1:5],km$std.err[1:5])
colnames(df_fly) <- c('Time','Surv','Std.error')
df_OP50 <- data.frame(km$time[6:10],km$surv[6:10],km$std.err[6:10])
colnames(df_OP50) <- c('Time','Surv','Std.error')
Time<- c(0,df_fly$Time)
Surv <- c(1,df_fly$Surv)
Std.error <- c(0,df_fly$Std.error)
df_fly <- data.frame(Time,Surv,Std.error)
Time<- c(0,df_OP50$Time)
Surv <- c(1,df_OP50$Surv)
Std.error <- c(0,df_OP50$Std.error)
df_OP50 <- data.frame(Time,Surv,Std.error)
plot(df_fly$Time[2:6],df_fly$Surv[2:6], pch = 16, cex = 1.2, xlab = 'Heatstress (hours)', 
     ylab = 'Surviving fraction', 
     main = expression('Survival Heat stress for'~italic(C. elegans)),
     xlim = c(0,13), ylim = c(0,1))
lines(df_fly$Time,df_fly$Surv)
arrows(df_fly$Time, df_fly$Surv-df_fly$Std.error, df_fly$Time, 
       df_fly$Surv+df_fly$Std.error, length=0.05, angle=90, code=3, col = 'black')
points(df_OP50$Time[2:6],df_OP50$Surv[2:6], pch = 1, cex = 1.2)
lines(df_OP50$Time,df_OP50$Surv, lty = 2)
arrows(df_OP50$Time, df_OP50$Surv-df_OP50$Std.error,
      df_OP50$Time, df_OP50$Surv+df_OP50$Std.error, 
      length=0.05, angle=90, code=3, col = 'black')
legend('bottomleft', pch = c(16,1),lty = c(1,2), 
       legend = c(expression('Fly gut 13'*degree*C),
                  expression(italic(E.coli) ~ OP50)), bty = 'n')
```

Now we test for difference between the curves with both log-rank and gehan-wilcoxon

```{r}
survdiff(Survobj ~media, data = data, rho = 0) 
survdiff(Survobj ~media, data = data, rho = 1) 
```

Which both don`t find a significant difference between the groups But we can make a nicer survival curve with a different package survminer and add readable confidence intervals

```{r}
ggsurvplot(km,data = data, conf.int = TRUE, ggtheme = theme_bw(),
           risk.table = 0.25, palette ='aaas', surv.median.line = 'hv',
           legend.labs = c(expression(Fly ~gut~13*degree*C), 'OP50'),
           legend.title = 'Media',break.x.by = 2) 
fit <- coxph(Survobj ~media, data = data)
ggsurvplot_combine(list(km1,km2),data = data, legend.labs =c('Anne ) )
```

We then try to split up in replicates to see if there are any differences
between scorers

```{r}
d1 <- data[data$Replicate == 1,]
d2 <- data[data$Replicate == 2,]
d1$Survobj <- with(d1,Surv(d1$Time, event = d1$status))
d2$Survobj <- with(d2,Surv(d2$Time, event = d2$status))
```

Then we make kaplan-meier curves

```{r}
par(mfrow = c(1,2))
km1 <- survfit(Survobj ~ media, data = d1,conf.type = "log-log")
plot(km1, col = c("blue","red"), conf.int = TRUE) 
legend("bottomleft",legend = c(expression(Fly ~ gut~13*degree*C), 'OP50'),
       col = c("blue","red"), lwd=1)
km2 <- survfit(Survobj ~ media, data = d2,conf.type = "log-log")
plot(km2, col = c("blue","red") ) 
legend("bottomleft",legend = c("FG20","OP50" ), col = c("blue","red"), lwd=1)
```

